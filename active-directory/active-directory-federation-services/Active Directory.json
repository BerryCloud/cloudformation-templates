{
  "AWSTemplateFormatVersion" : "2010-09-09",

  "Description" : "JSON string",

  "Parameters" : {

    "InstanceType" : {
      "Description" : "Amazon EC2 instance type",
      "Type" : "String",
      "Default" : "t2.small",
      "AllowedValues" : ["t2.micro", "t2.small", "t2.medium", "m3.medium", "m3.large", "m3.xlarge", "m3.2xlarge"]
    },

    "KeyPair" : {
      "Description" : "Public/private key pairs allow you to securely connect to your instance after it launches",
      "Type" : "String"
    }

  },

  "Mappings" : {

    "WindowsAMI"    : {
      "us-east-1" : {"64" : "ami-904be6f8"},
      "us-west-2" : {"64" : "ami-d38dcce3"},
      "us-west-1" : {"64" : "ami-09626b4c"},
      "eu-west-1" : {"64" : "ami-d02386a7"}
    },

    "LinuxAMI"  : {
      "us-east-1" : {"64" : "ami-4c9e4b24"},
      "us-west-2" : {"64" : "ami-bb69128b"},
      "us-west-1" : {"64" : "ami-2b2b296e"},
      "eu-west-1" : {"64" : "ami-3760b040"}
    }

  },

  "Conditions" : {
  },

  "Resources" : {

    "AD1" : {
      "DependsOn" : "NAT1",
      "Type" : "AWS::EC2::Instance",
      "Properties" : {
        "ImageId" : { "Fn::FindInMap" : [ "WindowsAMI", { "Ref" : "AWS::Region" }, "64"]},
        "InstanceType" : {"Ref" : "InstanceType"},
        "Tags" : [{"Key" : "Name", "Value" : "AD1"}],
        "BlockDeviceMappings" : [{"DeviceName" : "/dev/sda1","Ebs" : {"VolumeSize" : "60", "VolumeType" : "standard"}}],
        "KeyName" : {"Ref" : "KeyPair"},
        "UserData" : {"Fn::Base64" : {"Fn::Join" : ["",["<script>\n","cfn-init.exe -v -c config -s ",{"Ref" : "AWS::StackId"}," -r AD1"," --region ",{"Ref" : "AWS::Region"},"\n","</script>\n"]]}}
      },
      "Metadata" : {
        "AWS::CloudFormation::Init" : {
          "configSets" : {"config" : ["setup", "rename","installADDS"]},
          "setup" : {
            "files" : {
              "c:\\cfn\\scripts\\Rename-Computer.ps1" : {"source" : "https://github.com/BerryCloud/cloudformation-templates/blob/master/active-directory/active-directory-federation-services/Rename-Computer.ps1"},
              "c:\\cfn\\scripts\\Install-ADDS.ps1" : {"source" : "https://github.com/BerryCloud/cloudformation-templates/blob/master/active-directory/active-directory-federation-services/Install-ADDS.ps1"},
              "c:\\cfn\\scripts\\Configure-ADDS.ps1" : {"source" : "https://github.com/BerryCloud/cloudformation-templates/blob/master/active-directory/active-directory-federation-services/Configure-ADDS.ps1"}              
            }
          },
          "rename" : {
            "commands" : {
              "a-rename" : {
                "command" : "powershell.exe -ExecutionPolicy RemoteSigned -Command c:\\cfn\\scripts\\Rename-Computer.ps1 -NewName AD1",
                "waitAfterCompletion" : "forever"
              }
            }
          },
          "installADDS" : {
            "commands" : {
              "a-install-ADDS" : {
                "command" : "powershell.exe -ExecutionPolicy RemoteSigned c:\\cfn\\scripts\\Install-ADDS.ps1",
                "waitAfterCompletion" : 0
              },
              "b-configure-ADDS" : {
                "command" : "powershell.exe -ExecutionPolicy RemoteSigned c:\\cfn\\scripts\\Configure-ADDS.ps1 -DomainName internal.berrycloud.co.uk -DomainNetbiosName berrycloud -SafeModeAdministratorPassword hello123!",
                "waitAfterCompletion" : "forever"
              }              
            }
          }
        }
      }
    },

    "AD2" : {
      "DependsOn" : "AD1",      
      "Type" : "AWS::EC2::Instance",
      "Properties" : {
        "ImageId" : { "Fn::FindInMap" : [ "WindowsAMI", { "Ref" : "AWS::Region" }, "64"]},
        "InstanceType" : {"Ref" : "InstanceType"},
        "Tags" : [{"Key" : "Name", "Value" : "AD2"}],
        "BlockDeviceMappings" : [{"DeviceName" : "/dev/sda1","Ebs" : {"VolumeSize" : "60", "VolumeType" : "standard"}}],        
        "KeyName" : {"Ref" : "KeyPair"},
        "UserData" : {"Fn::Base64" : {"Fn::Join" : ["",["<script>\n","cfn-init.exe -v -c config -s ",{"Ref" : "AWS::StackId"}," -r AD2"," --region ",{"Ref" : "AWS::Region"},"\n","</script>\n"]]}}
      },
      "Metadata" : {
        "AWS::CloudFormation::Init" : {
          "configSets" : {"config" : ["setup", "rename"]},
          "setup" : {
            "files" : {
              "c:\\cfn\\scripts\\Rename-Computer.ps1" : {"source" : "https://s3-eu-west-1.amazonaws.com/berrycloud-powershell/AD/Rename-Computer.ps1"}
            }
          },
          "rename" : {
            "commands" : {
              "a-rename" : {
                "command" : "powershell.exe -ExecutionPolicy RemoteSigned -Command c:\\cfn\\scripts\\Rename-Computer.ps1 -NewName AD2",
                "waitAfterCompletion" : "forever"
              }
            }
          }
        }
      }
    },

    "FS1" : {
      "DependsOn" : "AD1",      
      "Type" : "AWS::EC2::Instance",
      "Properties" : {
        "ImageId" : { "Fn::FindInMap" : [ "WindowsAMI", { "Ref" : "AWS::Region" }, "64"]},
        "InstanceType" : {"Ref" : "InstanceType"},
        "Tags" : [{"Key" : "Name", "Value" : "FS1"}],
        "BlockDeviceMappings" : [{"DeviceName" : "/dev/sda1","Ebs" : {"VolumeSize" : "40", "VolumeType" : "standard"}}],        
        "KeyName" : {"Ref" : "KeyPair"},
        "UserData" : {"Fn::Base64" : {"Fn::Join" : ["",["<script>\n","cfn-init.exe -v -c config -s ",{"Ref" : "AWS::StackId"}," -r FS1"," --region ",{"Ref" : "AWS::Region"},"\n","</script>\n"]]}}        
      },
      "Metadata" : {
        "AWS::CloudFormation::Init" : {
          "configSets" : {"config" : ["setup", "rename"]},
          "setup" : {
            "files" : {
              "c:\\cfn\\scripts\\Rename-Computer.ps1" : {"source" : "https://s3-eu-west-1.amazonaws.com/berrycloud-powershell/AD/Rename-Computer.ps1"}
            }
          },
          "rename" : {
            "commands" : {
              "a-rename" : {
                "command" : "powershell.exe -ExecutionPolicy RemoteSigned -Command c:\\cfn\\scripts\\Rename-Computer.ps1 -NewName FS1",
                "waitAfterCompletion" : "forever"
              }
            }
          }
        }
      }      
    },

    "FS2" : {
      "DependsOn" : "FS1",
      "Type" : "AWS::EC2::Instance",
      "Properties" : {
        "ImageId" : { "Fn::FindInMap" : [ "WindowsAMI", { "Ref" : "AWS::Region" }, "64"]},
        "InstanceType" : {"Ref" : "InstanceType"},
        "Tags" : [{"Key" : "Name", "Value" : "FS2"}],
        "BlockDeviceMappings" : [{"DeviceName" : "/dev/sda1","Ebs" : {"VolumeSize" : "40", "VolumeType" : "standard"}}],        
        "KeyName" : {"Ref" : "KeyPair"},
        "UserData" : {"Fn::Base64" : {"Fn::Join" : ["",["<script>\n","cfn-init.exe -v -c config -s ",{"Ref" : "AWS::StackId"}," -r FS2"," --region ",{"Ref" : "AWS::Region"},"\n","</script>\n"]]}}
      },
      "Metadata" : {
        "AWS::CloudFormation::Init" : {
          "configSets" : {"config" : ["setup", "rename"]},
          "setup" : {
            "files" : {
              "c:\\cfn\\scripts\\Rename-Computer.ps1" : {"source" : "https://s3-eu-west-1.amazonaws.com/berrycloud-powershell/AD/Rename-Computer.ps1"}
            }
          },
          "rename" : {
            "commands" : {
              "a-rename" : {
                "command" : "powershell.exe -ExecutionPolicy RemoteSigned -Command c:\\cfn\\scripts\\Rename-Computer.ps1 -NewName FS2",
                "waitAfterCompletion" : "forever"
              }
            }
          }
        }
      }
    },

    "Sync" : {
      "DependsOn" : "AD1",
      "Type" : "AWS::EC2::Instance",
      "Properties" : {
        "ImageId" : { "Fn::FindInMap" : [ "WindowsAMI", { "Ref" : "AWS::Region" }, "64"]},
        "InstanceType" : {"Ref" : "InstanceType"},
        "Tags" : [{"Key" : "Name", "Value" : "Sync"}],
        "BlockDeviceMappings" : [{"DeviceName" : "/dev/sda1","Ebs" : {"VolumeSize" : "40", "VolumeType" : "standard"}}],        
        "KeyName" : {"Ref" : "KeyPair"},
        "UserData" : {"Fn::Base64" : {"Fn::Join" : ["",["<script>\n","cfn-init.exe -v -c config -s ",{"Ref" : "AWS::StackId"}," -r Sync"," --region ",{"Ref" : "AWS::Region"},"\n","</script>\n"]]}}        
      },
      "Metadata" : {
        "AWS::CloudFormation::Init" : {
          "configSets" : {"config" : ["setup", "rename"]},
          "setup" : {
            "files" : {
              "c:\\cfn\\scripts\\Rename-Computer.ps1" : {"source" : "https://s3-eu-west-1.amazonaws.com/berrycloud-powershell/AD/Rename-Computer.ps1"}
            }
          },
          "rename" : {
            "commands" : {
              "a-rename" : {
                "command" : "powershell.exe -ExecutionPolicy RemoteSigned -Command c:\\cfn\\scripts\\Rename-Computer.ps1 -NewName Sync",
                "waitAfterCompletion" : "forever"
              }
            }
          }
        }
      }      
    },

    "PFS1" : {
      "DependsOn" : "FS1",
      "Type" : "AWS::EC2::Instance",
      "Properties" : {
        "ImageId" : { "Fn::FindInMap" : [ "WindowsAMI", { "Ref" : "AWS::Region" }, "64"]},
        "InstanceType" : {"Ref" : "InstanceType"},
        "Tags" : [{"Key" : "Name", "Value" : "PFS1"}],
        "BlockDeviceMappings" : [{"DeviceName" : "/dev/sda1","Ebs" : {"VolumeSize" : "40", "VolumeType" : "standard"}}],        
        "KeyName" : {"Ref" : "KeyPair"},
        "UserData" : {"Fn::Base64" : {"Fn::Join" : ["",["<script>\n","cfn-init.exe -v -c config -s ",{"Ref" : "AWS::StackId"}," -r PFS1"," --region ",{"Ref" : "AWS::Region"},"\n","</script>\n"]]}}        
      },
      "Metadata" : {
        "AWS::CloudFormation::Init" : {
          "configSets" : {"config" : ["setup", "rename"]},
          "setup" : {
            "files" : {
              "c:\\cfn\\scripts\\Rename-Computer.ps1" : {"source" : "https://s3-eu-west-1.amazonaws.com/berrycloud-powershell/AD/Rename-Computer.ps1"}
            }
          },
          "rename" : {
            "commands" : {
              "a-rename" : {
                "command" : "powershell.exe -ExecutionPolicy RemoteSigned -Command c:\\cfn\\scripts\\Rename-Computer.ps1 -NewName PFS1",
                "waitAfterCompletion" : "forever"
              }
            }
          }
        }
      }      
    },

    "PFS2" : {
      "DependsOn" : "FS1",
      "Type" : "AWS::EC2::Instance",
      "Properties" : {
        "ImageId" : { "Fn::FindInMap" : [ "WindowsAMI", { "Ref" : "AWS::Region" }, "64"]},
        "InstanceType" : {"Ref" : "InstanceType"},
        "Tags" : [{"Key" : "Name", "Value" : "PFS2"}],
        "BlockDeviceMappings" : [{"DeviceName" : "/dev/sda1","Ebs" : {"VolumeSize" : "40", "VolumeType" : "standard"}}],        
        "KeyName" : {"Ref" : "KeyPair"},
        "UserData" : {"Fn::Base64" : {"Fn::Join" : ["",["<script>\n","cfn-init.exe -v -c config -s ",{"Ref" : "AWS::StackId"}," -r PFS2"," --region ",{"Ref" : "AWS::Region"},"\n","</script>\n"]]}}        
      },
      "Metadata" : {
        "AWS::CloudFormation::Init" : {
          "configSets" : {"config" : ["setup", "rename"]},
          "setup" : {
            "files" : {
              "c:\\cfn\\scripts\\Rename-Computer.ps1" : {"source" : "https://s3-eu-west-1.amazonaws.com/berrycloud-powershell/AD/Rename-Computer.ps1"}
            }
          },
          "rename" : {
            "commands" : {
              "a-rename" : {
                "command" : "powershell.exe -ExecutionPolicy RemoteSigned -Command c:\\cfn\\scripts\\Rename-Computer.ps1 -NewName PFS2",
                "waitAfterCompletion" : "forever"
              }
            }
          }
        }
      }      
    },

    "NAT1" : {
      "Type" : "AWS::EC2::Instance",
      "Properties" : {
        "ImageId" : { "Fn::FindInMap" : [ "LinuxAMI", { "Ref" : "AWS::Region" }, "64"]},
        "InstanceType" : {"Ref" : "InstanceType"},
        "Tags" : [{"Key" : "Name", "Value" : "NAT1"}],
        "KeyName" : {"Ref" : "KeyPair"},
        "SourceDestCheck" : "false"
      }
    }

  },

  "Outputs" : {
  }
}